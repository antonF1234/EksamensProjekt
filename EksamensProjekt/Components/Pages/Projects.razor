@page "/projects"
@inject NavigationManager Nav
@using EksamensProjekt.Models
@using EksamensProjektAPI.Services
@inject Blazored.LocalStorage.ILocalStorageService LS
@rendermode InteractiveServer
@inject HttpClient Http
@inject IJSRuntime JS

@inject ProjectRepo _Projects

<!--FORM TIL OPRETTELSE AF PROJEKT-->
<EditForm Model="newProject" OnValidSubmit="CreateProject">
    <DataAnnotationsValidator />
    <div class="mb-3">
        <label class="form-label">Navn</label>
        <InputText class="form-control" @bind-Value="newProject.Name" />
    </div>
    <div class="mb-3">
        <label class="form-label">Beskrivelse</label>
        <InputTextArea class="form-control" @bind-Value="newProject.Description" />
    </div>
    <div class="mb-3">
        <label class="form-label">Deadline</label>
        <InputDate class="form-control" @bind-Value="newProject.Deadline" />
    </div>
    <div class="mb-3">
        <label class="form-label">Status</label>
        <select class="form-select" @bind="newProject.Status">
            <option value="">--Vælg status--</option>
            <option value="Igang">Igang</option>
            <option value="Færdig">Færdig</option>
            <option value="På vent">På vent</option>
            <option value="Afbrudt">Afbrudt</option>
        </select>
    </div>

    <button class="btn btn-primary" type="submit">Opret projekt</button>


</EditForm>

@code {

    private ProjectModel newProject = new(); // Objekt der bindes til opret-projekt-formen


    private async Task CreateProject() // Opretter et nyt projekt og gemmer det i databasen
    {
        int uid = await LS.GetItemAsync<int>("userid"); // Henter bruger-ID fra LocalStorage
        await _Projects.InsertAsync(newProject, uid); // Indsætter projekt i databasen
        newProject = new ProjectModel(); // Nulstiller formularen
        await LoadProjects(); // Genindlæser projektlisten
    }

}

<h3 class="mb-4">Alle projekter</h3>

<!--VISNING AF PROJEKTER-->
@if (projects == null)
    
{
    <p>Henter projekter fra databasen...</p>                 @* Vises mens vi venter på svar *@
}
else if (projects.Count == 0)
{
    <div class="alert alert-info">Der er ingen projekter endnu – opret det første ovenfor!</div>
}
else
{
    <!-- Alle projekter vises som flotte kort -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var p in projects)
        {
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <!-- Projektnavn -->
                        <h5 class="card-title">@p.Name</h5>

                        <!-- Beskrivelse – vises kun hvis der er en -->
                        @if (!string.IsNullOrEmpty(p.Description))
                        {
                            <p class="card-text text-muted small">@p.Description</p>
                        }

                        <!-- Deadline og status -->
                        <p class="card-text mb-2">
                            <strong>Deadline:</strong>
                            @(p.Deadline?.ToString("dd-MM-yyyy") ?? "Ikke sat")
                        </p>
                        <p class="card-text">
                            <strong>Status:</strong>
                            <span class="badge bg-primary">
                                @(p.Status ?? "Ny")
                            </span>
                        </p>
                    </div>

                    <div class="card-footer text-muted small">
                        ID: @p.ProjectId
                    </div>
                    
                    <button class="btn btn-outline-primary btn-sm mt-2" @onclick="() => OpenTaskModal(p)">
                        Vis tasks
                    </button>
                    <button class="btn-danger" @onclick="() => DeleteProject(p.ProjectId)">Slet</button>
                    <button class="btn btn-primary" @onclick="() => OpenUpdateProjectModal(p)">Updater</button>


                </div>
            </div>
        }
    </div>
}

<!--TASK MODAL-->
@if (showTaskModal && selectedProject != null)
{
    <div class="modal-backdrop" @onclick="CloseTaskModal"></div>

    <div class="modal-window">
        <h5>Tasks for @selectedProject.Name</h5>

        @if (projectTasks.Count == 0)
        {
            <p>Ingen tasks for dette projekt endnu.</p>
        }
        else
        {
            <ul class="list-group">
                @foreach (var t in projectTasks)
                {
                    <li class="list-group-item">
                        <strong>@t.Name</strong> - @(t.Status ?? "Ny") 
                        @if (t.Deadline.HasValue)
                        {
                            <span class="text-muted"> (Deadline: @t.Deadline.Value.ToString("dd-MM-yyyy"))</span>
                        }
                    </li>
                }
            </ul>
        }

        <button class="btn btn-secondary" type="button" @onclick="CloseTaskModal">Luk</button>

    </div>
}

<!--OPDATER PROJEKT MODAL-->
@if (showProjectUpdateModal && selectedProject != null)
{
    <div class="modal-backdrop" @onclick="CloseUpdateProjectModal"></div>

    <div class="modal-window">
        <EditForm Model="selectedProject" OnValidSubmit="UpdateProject">
            <div class="mb-3">
                <label>Navn</label>
                <InputText class="form-control" @bind-Value="selectedProject.Name" />
            </div>

            <div class="mb-3">
                <label>Beskrivelse</label>
                <InputText class="form-control" @bind-Value="selectedProject.Description" />
            </div>

            <div class="mb-3">
                <label>Status</label>
                <select class="form-select" @bind="selectedProject.Status">
                    <option value="">--Vælg status--</option>
                    <option value="Igang">Igang</option>
                    <option value="Færdig">Færdig</option>
                    <option value="På vent">På vent</option>
                    <option value="Afbrudt">Afbrudt</option>
                </select>
            </div>


            <button class="btn btn-success me-2" type="submit">Gem</button>
            <button class="btn btn-secondary" type="button" @onclick="CloseUpdateProjectModal">Luk</button>
        </EditForm>
    </div>
}


@code { // UI-state
    private bool showTaskModal = false;
    private bool showProjectUpdateModal = false;
    private ProjectModel? selectedProject; // Valgt projekt
    private List<TaskModel> projectTasks = new(); // Tasks til valgt projekt
    

    private async Task DeleteProject(int pid) // Sletter et projekt efter brugerbekræftelse
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Er du sikker på du vil slette dette projekt");
        if (confirmed) //pop up vindue
        {
            await Http.DeleteAsync($"api/delete/{pid}"); //sletter med det samme
            await LoadProjects(); //genindlæs projektet
        }
    }
    
    // Åbner modal og henter tasks for et projekt
    private async Task OpenTaskModal(ProjectModel project) 
    {
        selectedProject = project;
        showTaskModal = true;

        // Fetch tasks from API by project ID
        projectTasks = await Http.GetFromJsonAsync<List<TaskModel>>($"api/tasks/project/{project.ProjectId}") 
                       ?? new List<TaskModel>();
    }

    private void OpenUpdateProjectModal(ProjectModel p)
    {
        selectedProject = p;
        showProjectUpdateModal = true;
    }

    private void CloseUpdateProjectModal()
    {
        selectedProject = null;
        showProjectUpdateModal = false;
    }

    private async Task UpdateProject()
    {
        if (selectedProject != null)
        {
            await _Projects.UpdateAsync(selectedProject);
            await LoadProjects(); //genindlæs projektet
            selectedProject = null;
            CloseUpdateProjectModal();
        }
    }


    private void CloseTaskModal()
    {
        selectedProject = null;
        projectTasks.Clear();
        showTaskModal = false;
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadProjects(); //genindlæs projektet
    }
    
    // Liste med alle projekter fra databasen
    private List<ProjectModel> projects = new();
    
    // Henter projekter fra API’et (bliver brugt flere gange)
    private async Task LoadProjects() 
    {
        projects = await Http.GetFromJsonAsync<List<ProjectModel>>("api/all");
        if (projects == null)
        {
            projects = new List<ProjectModel>();
        }

    }
}
