@page "/mytasks"
@inject NavigationManager Nav
@using EksamensProjekt.Models
@using EksamensProjektAPI.Services
@inject Blazored.LocalStorage.ILocalStorageService LS
@rendermode InteractiveServer
@inject HttpClient Http
@inject IJSRuntime JS
<h3>MyTasks</h3>

@if (tasks == null)
    
{
    <p>Henter opgaver fra databasen...</p>                 @* Vises mens vi venter på svar *@
}
else if (tasks.Count == 0 && isLoaded == true)
{
    <div class="alert alert-info">Der er ingen opgaver endnu</div>
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var t in tasks)
        {
            <div class="col">
                <div class="card h-100 shadow-sm border-primary">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@t.TaskName</h5>
                        <h6 class="card-subtitle mb-2 text-muted">ID: @t.TaskId</h6>
                        <p class="mb-1"><strong>Status:</strong> 
                            <span class="badge @(t.Status == "Færdig" ? "bg-success" : t.Status == "Igang" ? "bg-warning" : "bg-secondary")">
                                @t.Status
                            </span>
                        </p>

                        <select class="form-select mb-2" @onchange="@(e => OpdaterStatus(t.TaskId, e.Value.ToString()))">
                            <option value="">--Vælg status--</option>
                            <option value="Igang" selected="@(t.Status=="Igang")">Igang</option>
                            <option value="Færdig" selected="@(t.Status=="Færdig")">Færdig</option>
                            <option value="På vent" selected="@(t.Status=="På vent")">På vent</option>
                            <option value="Afbrudt" selected="@(t.Status=="Afbrudt")">Afbrudt</option>
                        </select>

                        @if(t.StartDate.HasValue)
                        {
                            <p class="mb-1"><strong>Start:</strong> @t.StartDate.Value.ToString("dd/MM/yyyy")</p>
                        }
                        @if(t.Deadline.HasValue)
                        {
                            <p class="mb-1"><strong>Deadline:</strong> @t.Deadline.Value.ToString("dd/MM/yyyy")</p>
                        }
                        @if(t.CompletionDate.HasValue)
                        {
                            <p class="mb-1"><strong>Færdig:</strong> @t.CompletionDate.Value.ToString("dd/MM/yyyy")</p>
                        }
                    </div>
                </div>
            </div>
        }
    </div>


}

@code {
    private List<UsersTasksModel> tasks = new();
    private int userId;
    private bool isLoaded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Retrieve user ID from local storage (requires JS runtime)
            userId = await LS.GetItemAsync<int>("userid");

            // Load tasks
            tasks = await Http.GetFromJsonAsync<List<UsersTasksModel>>($"api/userstasks/getuserstasks/{userId}") 
                    ?? new List<UsersTasksModel>();

            isLoaded = true;

            // Trigger UI update
            StateHasChanged();
        }
    }
    // dropdown menu
    private async Task OpdaterStatus(int taskId, string status)
    {
        if (string.IsNullOrEmpty(status))
            return;

        var response = await Http.PutAsync($"/api/tasks/updatestatus/{taskId}/{status}", null);
        if (response.IsSuccessStatusCode)
        {
            // Opdater den lokale task-liste for at reflektere ændringen i UI
            var task = tasks.FirstOrDefault(t => t.TaskId == taskId);
            if (task != null)
                task.Status = status;
        }
        else
        {
            Console.WriteLine($"Fejl ved opdatering af status: {response.ReasonPhrase}");
        }
    }
    
}


