@page "/Tasks"
@inject NavigationManager Nav
@using EksamensProjekt.Models
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveServer

<h3>Opgaver</h3>

<!-- Opret ny task -->
<EditForm Model="newTask" OnValidSubmit="CreateNewTask">
    <DataAnnotationsValidator />
    <div class="mb-3">
        <label class="form-label">Navn</label>
        <InputText class="form-control" @bind-Value="newTask.Name" />
    </div>
    <div class="mb-3">
        <label class="form-label">Start dato</label>
        <InputDate class="form-control" @bind-Value="newTask.StartDate" />
    </div>
    <div class="mb-3">
        <label class="form-label">Deadline</label>
        <InputDate class="form-control" @bind-Value="newTask.Deadline" />
    </div>
    <div class="mb-3">
        <label class="form-label">Status</label>
        <InputText class="form-control" @bind-Value="newTask.Status" />
    </div>
    <div class="mb-3">
        <label class="form-label">Projekt</label>
        <select class="form-select" @bind="selectedProjectId">
            <option value="">Vælg projekt...</option>
            @foreach (var project in projects)
            {
                <option value="@project.ProjectId">@project.Name</option>
            }
        </select>
    </div>
    <button class="btn btn-primary" type="submit">Opret opgave</button>
</EditForm>

<hr />

<!-- GRUPPERET LISTE OVER TASKS -->
@if (groupedTasks.Count == 0)
{
    <p>Ingen opgaver</p>
}
else
{
    @foreach (var group in groupedTasks)
    {
        <h4 class="mt-4">@group.Project?.Name</h4>

        @foreach (var task in group.Tasks)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">@task.Name</h5>
                    <ul class="list-unstyled mb-0">
                        <li><strong>Start:</strong> @task.StartDate</li>
                        <li><strong>Deadline:</strong> @task.Deadline</li>
                        <li><strong>Completed:</strong> @task.CompletionDate</li>
                        <li><strong>Status:</strong> @task.Status</li>
                    </ul>

                    <button class="btn btn-primary btn-sm mt-2" @onclick="() => OpenUpdateTaskModal(task)">Updater</button>
                    <button class="btn btn-danger btn-sm mt-2" @onclick="() => DeleteTask(task.TaskId)">Slet</button>
                </div>
            </div>
        }
    }
}

<!-- Modal til opdatering af task -->
@if (showUpdateTaskModal && SelectedTask != null)
{
    <div class="modal-backdrop" @onclick="CloseUpdateTaskModal"></div>
    <div class="modal-window p-3 bg-white rounded shadow">
        <h5>Opdater Task: @SelectedTask.Name</h5>
        <EditForm Model="SelectedTask" OnValidSubmit="UpdateTask">
            <div class="mb-3">
                <label class="form-label">Navn</label>
                <InputText class="form-control" @bind-Value="SelectedTask.Name" />
            </div>
            <div class="mb-3">
                <label class="form-label">Start dato</label>
                <InputDate class="form-control" @bind-Value="SelectedTask.StartDate" />
            </div>
            <div class="mb-3">
                <label class="form-label">Deadline</label>
                <InputDate class="form-control" @bind-Value="SelectedTask.Deadline" />
            </div>
            <div class="mb-3">
                <label class="form-label">Status</label>
                <InputText class="form-control" @bind-Value="SelectedTask.Status" />
            </div>
            <button class="btn btn-success me-2" type="submit">Gem</button>
            <button class="btn btn-secondary" @onclick="CloseUpdateTaskModal" type="button">Luk</button>
        </EditForm>
    </div>
}

@code {
    private TaskModel newTask = new();
    private TaskModel? SelectedTask;
    private List<TaskModel> tasks = new();
    private List<ProjectModel> projects = new();
    private List<ProjectGroup> groupedTasks = new();
    private int selectedProjectId;
    private bool showUpdateTaskModal = false;

    protected override async Task OnInitializedAsync()
    {
        projects = await Http.GetFromJsonAsync<List<ProjectModel>>("api/all") ?? new List<ProjectModel>();
        await LoadAllTasks();
        await GroupTasks();
    }

    private async Task LoadAllTasks()
    {
        tasks = await Http.GetFromJsonAsync<List<TaskModel>>("api/tasks/all") ?? new List<TaskModel>();
    }

    private async Task GroupTasks()
    {
        groupedTasks.Clear();

        var projectIds = tasks.Select(t => t.ProjectId).Distinct();

        foreach (var pid in projectIds)
        {
            var project = await Http.GetFromJsonAsync<ProjectModel>($"api/{pid}");
            var projectTasks = tasks.Where(t => t.ProjectId == pid).ToList();

            groupedTasks.Add(new ProjectGroup
            {
                Project = project,
                Tasks = projectTasks
            });
        }
    }

    private async Task CreateNewTask()
    {
        if (selectedProjectId == 0) return;

        await Http.PostAsJsonAsync($"api/tasks/createtask/{selectedProjectId}", newTask);
        await LoadAllTasks();
        await GroupTasks();

        newTask = new TaskModel();
    }

    private async Task DeleteTask(int tid)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Er du sikker på du vil slette denne task?"))
            return;

        var response = await Http.DeleteAsync($"api/tasks/delete/{tid}");

        if (response.IsSuccessStatusCode)
        {
            await LoadAllTasks();
            await GroupTasks();
        }
    }

    private void OpenUpdateTaskModal(TaskModel task)
    {
        SelectedTask = new TaskModel
        {
            TaskId = task.TaskId,
            Name = task.Name,
            StartDate = task.StartDate,
            Deadline = task.Deadline,
            CompletionDate = task.CompletionDate,
            Status = task.Status,
            ProjectId = task.ProjectId
        };
        showUpdateTaskModal = true;
    }

    private void CloseUpdateTaskModal()
    {
        SelectedTask = null;
        showUpdateTaskModal = false;
    }

    private async Task UpdateTask()
    {
        if (SelectedTask == null) return;

        var response = await Http.PutAsJsonAsync($"api/tasks/update/{SelectedTask.TaskId}", SelectedTask);

        if (response.IsSuccessStatusCode)
        {
            await LoadAllTasks();
            await GroupTasks();
            CloseUpdateTaskModal();
        }
    }

    private class ProjectGroup
    {
        public ProjectModel? Project { get; set; }
        public List<TaskModel> Tasks { get; set; } = new();
    }
}
