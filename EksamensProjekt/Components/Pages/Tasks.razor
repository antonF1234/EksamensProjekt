@page "/Tasks"
@inject NavigationManager Nav
@using EksamensProjekt.Models
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveServer

<h3>Opret ny opgave</h3>
<EditForm Model="newTask" OnValidSubmit="CreateNewTask" class="mb-4">
    <DataAnnotationsValidator />
    <div class="row g-2">
        <div class="col-md-2">
            <InputText class="form-control" placeholder="Navn" @bind-Value="newTask.Name" />
        </div>
        <div class="col-md-2">
            <InputText class="form-control" placeholder="Beskrivelse" @bind-Value="newTask.Description" />
        </div>
        <div class="col-md-2">
            <InputDate class="form-control" @bind-Value="newTask.Deadline" />
        </div>
        <div class="col-md-2">
            <InputDate class="form-control" @bind-Value="newTask.StartDate" />
        </div>
        <div class="col-md-2">
            <select class="form-select" @bind="newTask.Status">
                <option value="">--Vælg status--</option>
                <option value="Igang">Igang</option>
                <option value="Færdig">Færdig</option>
                <option value="På vent">På vent</option>
                <option value="Afbrudt">Afbrudt</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" @bind="selectedProjectId">
                <option value="">Vælg projekt...</option>
                @foreach (var project in projects)
                {
                    <option value="@project.ProjectId">@project.Name</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">Opret</button>
        </div>
    </div>
</EditForm>

<div class="row mb-4">
    <div class="col-md-4">
        <select class="form-select" @bind="selectedUserId">
            <option value="">Vælg bruger...</option>
            @foreach (var u in users)
            {
                <option value="@u.UserId">@u.Username</option>
            }
        </select>
    </div>
    <div class="col-md-4">
        <select class="form-select" @bind="selectedTaskId">
            <option value="">Vælg opgave...</option>
            @foreach (var task in tasks)
            {
                <option value="@task.TaskId">@task.Name</option>
            }
        </select>
    </div>
    <div class="col-md-4">
        <button class="btn btn-primary w-100" @onclick="AddSelectedUser" disabled="@(!CanAdd)">
            Tilføj bruger til opgave
        </button>
    </div>
</div>

<hr />

@if (groupedTasks.Count == 0)
{
    <p>Ingen opgaver</p>
}
else
{
    @foreach (var taskGroup in groupedTasks)
    {
        <h4 class="mt-4">@taskGroup.Project?.Name</h4>

        @foreach (var task in taskGroup.Tasks)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">@task.Name</h5>
                    <p class="card-text">@task.Description</p>
                    <ul class="list-unstyled mb-0">
                        <li><strong>Start:</strong> @task.StartDate</li>
                        <li><strong>Deadline:</strong> @task.Deadline</li>
                        <li><strong>Completed:</strong> @task.CompletionDate</li>
                        <li><strong>Status:</strong> @task.Status</li>
                    </ul>

                    @if (taskUsersMap.ContainsKey(task.TaskId))
                    {
                        <div class="mt-2">
                            @foreach (var user in taskUsersMap[task.TaskId])
                            {
                                <span class="badge bg-primary me-1">
                                    @user.Username
                                    <button class="btn btn-sm btn-link text-white p-0 ms-1"
                                            @onclick="() => DelUserFromTask(task.TaskId, user.UserId)">
                                        ✕
                                    </button>
                                </span>
                            }

                        </div>
                    }

                    <button class="btn btn-primary btn-sm mt-2" @onclick="() => OpenUpdateTaskModal(task)">Updater</button>
                    <button class="btn btn-danger btn-sm mt-2" @onclick="() => DeleteTask(task.TaskId)">Slet</button>
                </div>
            </div>
        }
    }
}

<!-- Modal til opdatering af task -->
@if (showUpdateTaskModal && SelectedTask != null)
{
    <div class="modal-backdrop" @onclick="CloseUpdateTaskModal"></div>
    <div class="modal-window p-3 bg-white rounded shadow">
        <h5>Opdater Task: @SelectedTask.Name</h5>
        <EditForm Model="SelectedTask" OnValidSubmit="UpdateTask">
            <div class="mb-3">
                <label class="form-label">Navn</label>
                <InputText class="form-control" @bind-Value="SelectedTask.Name" />
            </div>
            <div class="mb-3">
                <label class="form-label">Beskrivelse</label>
                <InputText class="form-control" @bind-Value="SelectedTask.Description" />
            </div>
            
            <div class="mb-3">
                <label class="form-label">Start dato</label>
                <InputDate class="form-control" @bind-Value="SelectedTask.StartDate" />
            </div>
            <div class="mb-3">
                <label class="form-label">Deadline</label>
                <InputDate class="form-control" @bind-Value="SelectedTask.Deadline" />
            </div>
            <div class="mb-3">
                <select class="form-select" @bind="SelectedTask.Status">
                    <option value="">--Vælg status--</option>
                    <option value="Igang">Igang</option>
                    <option value="Færdig">Færdig</option>
                    <option value="På vent">På vent</option>
                    <option value="Afbrudt">Afbrudt</option>
                </select>
            </div>
            <button class="btn btn-success me-2" type="submit">Gem</button>
            <button class="btn btn-secondary" @onclick="CloseUpdateTaskModal" type="button">Luk</button>
        </EditForm>
    </div>
}

@code {
    private TaskModel newTask = new();
    private TaskModel? SelectedTask;
    private List<TaskModel> tasks = new();
    private List<ProjectModel> projects = new();
    private List<ProjectGroup> groupedTasks = new();
    private int selectedProjectId;
    private bool showUpdateTaskModal = false;
    private List<UserModel> users = new();
    private int? selectedUserId;
    private int? selectedTaskId;
    private bool CanAdd => selectedUserId.HasValue && selectedTaskId.HasValue;
    private Dictionary<int, List<UserModel>> taskUsersMap = new();

    private async Task LoadAllTasks()
    {
        tasks = await Http.GetFromJsonAsync<List<TaskModel>>("api/tasks/all") ?? new List<TaskModel>();
    }

    private async Task GroupTasks()
    {
        groupedTasks.Clear();
        var projectIds = tasks.Select(t => t.ProjectId).Distinct();

        foreach (var pid in projectIds)
        {
            var project = await Http.GetFromJsonAsync<ProjectModel>($"api/{pid}");
            var projectTasks = tasks.Where(t => t.ProjectId == pid).ToList();

            groupedTasks.Add(new ProjectGroup
            {
                Project = project,
                Tasks = projectTasks
            });
        }
    }

    private async Task CreateNewTask()
    {
        if (selectedProjectId == 0) return;

        await Http.PostAsJsonAsync($"api/tasks/createtask/{selectedProjectId}", newTask);
        await LoadAllTasks();
        await GroupTasks();
        await LoadTaskUsers(); // opdater map
        newTask = new TaskModel();
    }

    private async Task LoadTaskUsers()
    {
        taskUsersMap.Clear();
        foreach (var task in tasks)
        {
            var usersForTask = await Http.GetFromJsonAsync<List<UserModel>>(
                $"api/userstasks/getusersfromtask/{task.TaskId}") ?? new List<UserModel>();
            taskUsersMap[task.TaskId] = usersForTask;
        }
    }

    private async Task DeleteTask(int tid)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Er du sikker på du vil slette denne task?"))
            return;

        var response = await Http.DeleteAsync($"api/tasks/delete/{tid}");
        if (response.IsSuccessStatusCode)
        {
            await LoadAllTasks();
            await GroupTasks();
            await LoadTaskUsers();
        }
    }

    private void OpenUpdateTaskModal(TaskModel task)
    {
        SelectedTask = new TaskModel
        {
            TaskId = task.TaskId,
            Name = task.Name,
            Description = task.Description,
            StartDate = task.StartDate,
            Deadline = task.Deadline,
            CompletionDate = task.CompletionDate,
            Status = task.Status,
            ProjectId = task.ProjectId
        };
        showUpdateTaskModal = true;
    }

    private void CloseUpdateTaskModal()
    {
        SelectedTask = null;
        showUpdateTaskModal = false;
    }

    private async Task UpdateTask()
    {
        if (SelectedTask == null) return;

        var response = await Http.PutAsJsonAsync($"api/tasks/update/{SelectedTask.TaskId}", SelectedTask);
        if (response.IsSuccessStatusCode)
        {
            await LoadAllTasks();
            await GroupTasks();
            await LoadTaskUsers();
            CloseUpdateTaskModal();
        }
    }

    private async Task AddSelectedUser()
    {
        if (selectedUserId.HasValue && selectedTaskId.HasValue)
        {
            await Http.PostAsync($"api/userstasks/addusertask/{selectedTaskId}/{selectedUserId}", null);
            selectedUserId = null;
            selectedTaskId = null;
            await LoadTaskUsers();
        }
    }

    private async Task LoadUsers()
    {
        users = await Http.GetFromJsonAsync<List<UserModel>>("api/users/allusers"); // ?? new List<UserModel>();
    }

    protected override async Task OnInitializedAsync()
    {
        projects = await Http.GetFromJsonAsync<List<ProjectModel>>("api/all"); //?? new List<ProjectModel>();
        await LoadAllTasks();
        await GroupTasks();
        await LoadUsers();
        await LoadTaskUsers();
    }

    private class ProjectGroup
    {
        public ProjectModel? Project { get; set; }
        public List<TaskModel> Tasks { get; set; } = new();
    }

    private async Task DelUserFromTask(int taskId, int userId)
    {
        await Http.DeleteAsync(
            $"api/userstasks/deluserfromtask/{taskId}/{userId}");

        tasks.Clear();
        groupedTasks.Clear();
        taskUsersMap.Clear();

        await OnInitializedAsync();
    }
}
