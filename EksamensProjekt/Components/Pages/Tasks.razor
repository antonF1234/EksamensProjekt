@page "/Tasks"                           
@inject NavigationManager Nav           
@using EksamensProjekt.Models            
@inject HttpClient Http                  
@inject IJSRuntime JS                    
@rendermode InteractiveServer            

<h3>Opret ny opgave</h3>

<!-- Formular til at oprette en ny opgave -->
<EditForm Model="newTask" OnValidSubmit="CreateNewTask" class="mb-4">
    <DataAnnotationsValidator />     

    <div class="row g-2">
        <div class="col-md-2">
            <InputText class="form-control" placeholder="Navn" @bind-Value="newTask.Name" /> <!-- Opgavens navn -->
        </div>
        <div class="col-md-2">
            <InputText class="form-control" placeholder="Beskrivelse" @bind-Value="newTask.Description" /> <!-- Beskrivelse -->
        </div>
        <div class="col-md-2">
            <InputDate class="form-control" @bind-Value="newTask.Deadline" /> <!-- Deadline-dato -->
        </div>
        <div class="col-md-2">
            <InputDate class="form-control" @bind-Value="newTask.StartDate" /> <!-- Startdato -->
        </div>
        <div class="col-md-2">
            <!-- Dropdown til at vælge status -->
            <select class="form-select" @bind="newTask.Status">
                <option value="">--Vælg status--</option>
                <option value="Igang">Igang</option>
                <option value="Færdig">Færdig</option>
                <option value="På vent">På vent</option>
                <option value="Afbrudt">Afbrudt</option>
            </select>
        </div>
        <div class="col-md-2">
            <!-- Vælg hvilket projekt opgaven skal tilknyttes -->
            <select class="form-select" @bind="selectedProjectId">
                <option value="">Vælg projekt...</option>
                @foreach (var project in projects)
                {
                    <option value="@project.ProjectId">@project.Name</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">Opret</button> <!-- opret -->
        </div>
    </div>
</EditForm>

<!--tilknytning af bruger til en eksisterende opgave -->
<div class="row mb-4">
    <div class="col-md-4">
        <!-- Dropdown-menu til at vælge en medarbejder/bruger -->
        <select class="form-select" @bind="selectedUserId">
            <option value="">Vælg bruger...</option>
            <!-- Loop der går igennem alle brugere i listen "users" -->
            <!-- For hver bruger (vi kalder den midlertidigt "u") laver vi en <option> -->
            @foreach (var u in users)
            {
                <!-- Værdien (value) er brugerens ID (skjult for brugeren) -->
                <!-- Teksten der vises er brugernavnet (fx "Mike") -->
                <option value="@u.UserId">@u.Username</option>
            }
        </select>
    </div>
    <div class="col-md-4">
        <select class="form-select" @bind="selectedTaskId">
            <option value="">Vælg opgave...</option>
            @foreach (var task in tasks)
            {
                <option value="@task.TaskId">@task.Name</option>
            }
        </select>
    </div>
    <div class="col-md-4">
        <!-- Knap er deaktiveret, hvis man ikke har valgt både bruger og opgave -->
        <button class="btn btn-primary w-100" @onclick="AddSelectedUser" disabled="@(!CanAdd)">
            Tilføj bruger til opgave
        </button>
    </div>
</div>

<hr />

<!-- Visning af alle opgaver, grupperet efter projekt -->
@if (groupedTasks.Count == 0)
{
    <!-- Hvis der slet ingen opgaver er i systemet -->
    <p>Ingen opgaver</p>
}
else
{
    <!-- Loop gennem hver projektgruppe (ét projekt ad gangen) -->
    @foreach (var taskGroup in groupedTasks)
    {
        <!-- Stort kort der repræsenterer ét projekt -->
        <div class="card mb-4 shadow-sm">
            <!-- Projekt-navn som overskrift -->
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">@taskGroup.Project?.Name</h4>
                <!-- ?. betyder: vis kun Name hvis Project ikke er null -->
            </div>
            <div class="card-body">
                <!-- Tjekker om projektet har nogle opgaver -->
                @if (taskGroup.Tasks.Any())
                {
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                        <!-- Indre loop: én opgave ad gangen inden for dette projekt -->
                        @foreach (var task in taskGroup.Tasks)
                        {
                            <div class="col">
                                <div class="card h-100 border-secondary">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">@task.Name</h5>
                                        <p class="card-text">@task.Description</p>
                                        <ul class="list-unstyled mb-2">
                                            <!-- Liste med vigtige detaljer -->
                                            <li><strong>Start:</strong> @task.StartDate</li>
                                            <li><strong>Deadline:</strong> @task.Deadline</li>
                                            <li><strong>Completed:</strong> @(task.CompletionDate.HasValue ? task.CompletionDate.Value.ToShortDateString() : "-")</li>
                                            <li><strong>Status:</strong> @task.Status</li>
                                        </ul>

                                        <!-- Viser hvilke brugere der er tilknyttet opgaven -->
                                        @if (taskUsersMap.ContainsKey(task.TaskId))
                                        {
                                            <div class="mb-2">
                                                @foreach (var user in taskUsersMap[task.TaskId])
                                                {
                                                    <span class="badge bg-primary me-1">
                                                        @user.Username
                                                        <!-- Lille kryds til at fjerne brugeren fra opgaven -->
                                                        <button class="btn btn-sm btn-link text-white p-0 ms-1"
                                                                @onclick="() => DelUserFromTask(task.TaskId, user.UserId)">
                                                            ✕
                                                        </button>
                                                    </span>
                                                }
                                            </div>
                                        }

                                        <!-- Knapper nederst i kortet -->
                                        <div class="mt-auto d-flex gap-2">
                                            <button class="btn btn-primary btn-sm" @onclick="() => OpenUpdateTaskModal(task)">Updater</button>
                                            <button class="btn btn-danger btn-sm" @onclick="() => DeleteTask(task.TaskId)">Slet</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <!-- Hvis projektet findes, men ingen opgaver er tilknyttet -->
                    <p class="text-muted">Ingen opgaver i dette projekt.</p>
                }
            </div>
        </div>
    }
}

<!-- Modalpop-up vindue til at opdatere en opgave -->
@if (showUpdateTaskModal && SelectedTask != null)
{
    <div class="modal-backdrop" @onclick="CloseUpdateTaskModal"></div> <!-- mørk baggrund - lukker ved klik udenfor -->
    <div class="modal-window p-3 bg-white rounded shadow">
        <h5>Opdater Task: @SelectedTask.Name</h5>
        <EditForm Model="SelectedTask" OnValidSubmit="UpdateTask">
            <div class="mb-3">
                <label class="form-label">Navn</label>
                <InputText class="form-control" @bind-Value="SelectedTask.Name" />
            </div>
            <div class="mb-3">
                <label class="form-label">Beskrivelse</label>
                <InputText class="form-control" @bind-Value="SelectedTask.Description" />
            </div>
            <div class="mb-3">
                <label class="form-label">Start dato</label>
                <InputDate class="form-control" @bind-Value="SelectedTask.StartDate" />
            </div>
            <div class="mb-3">
                <label class="form-label">Deadline</label>
                <InputDate class="form-control" @bind-Value="SelectedTask.Deadline" />
            </div>
            <div class="mb-3">
                <select class="form-select" @bind="SelectedTask.Status">
                    <option value="">--Vælg status--</option>
                    <option value="Igang">Igang</option>
                    <option value="Færdig">Færdig</option>
                    <option value="På vent">På vent</option>
                    <option value="Afbrudt">Afbrudt</option>
                </select>
            </div>
            <button class="btn btn-success me-2" type="submit">Gem</button>
            <button class="btn btn-secondary" @onclick="CloseUpdateTaskModal" type="button">Luk</button>
        </EditForm>
    </div>
}

@code {
    // Variabler til data
    private TaskModel newTask = new();                   // Ny opgave der oprettes
    private TaskModel? SelectedTask;                     // Opgaven vi er ved at opdatere
    private List<TaskModel> tasks = new();              // Alle opgaver
    private List<ProjectModel> projects = new();         // Alle projekter
    private List<ProjectGroup> groupedTasks = new();    // Opgaver grupperet efter projekt
    private int selectedProjectId;                       // Valgt projekt ved ny opgave
    private bool showUpdateTaskModal = false;           // Viser/skjuler opdaterings-modal
    private List<UserModel> users = new();              // Alle brugere
    private int? selectedUserId;                        // Valgt bruger 
    private int? selectedTaskId;                        // Valgt opgave 
    private bool CanAdd => selectedUserId.HasValue && selectedTaskId.HasValue; // Aktiverer knap kun hvis begge er valgt
    private Dictionary<int, List<UserModel>> taskUsersMap = new(); // Kortlægger hvilke brugere der hører til hver opgave

// Henter alle opgaver fra backend-API'et og gemmer dem i listen 'tasks'
    private async Task LoadAllTasks()
    {
        // Sender en GET-forespørgsel til endpointet /api/tasks/all
        // GetFromJsonAsync konverterer automatisk JSON-svaret til en List<TaskModel>
        // await venter på, at dataene er hentet færdigt fra serveren
        tasks = await Http.GetFromJsonAsync<List<TaskModel>>("api/tasks/all") 
                ?? new List<TaskModel>(); // Hvis der ikke kommer data (fx ingen forbindelse), så brug en tom liste i stedet for null
    }

    // Grupperer opgaver efter projekt 
    private async Task GroupTasks()
    {
        groupedTasks.Clear(); // Tøm den gamle gruppering først
        var projectIds = tasks.Select(t => t.ProjectId).Distinct();
        // Finder alle unikke ProjectId'er fra opgaverne (fx 1, 3,)
        foreach (var pid in projectIds)
        {
            var project = await Http.GetFromJsonAsync<ProjectModel>($"api/{pid}");
            // Henter selve projekt-objektet (med navn, beskrivelse osv.) ud fra ID
            var projectTasks = tasks.Where(t => t.ProjectId == pid).ToList();
            // Finder alle opgaver, der hører til dette projekt
            groupedTasks.Add(new ProjectGroup
            {
                Project = project, // Projekt-info (navn osv.)
                Tasks = projectTasks // Listen af opgaver under det
            });
        }
    }

// Denne metode kører, når man trykker på "Opret"-knappen i formularen øverst
    private async Task CreateNewTask()
    {
        // Tjekker først, om man har valgt et projekt i dropdown'en
        // Hvis selectedProjectId er 0 har man ikke valgt noget projekt endnu
        // Så stopper vi bare metoden med det samme – vi vil jo ikke lave en opgave uden projekt
        if (selectedProjectId == 0) return;

        // Her sender vi den nye opgave (som brugeren har udfyldt i formularen) op til serveren
        // Vi bruger PostAsJsonAsync, fordi vi skal sende data med (newTask) som JSON
        await Http.PostAsJsonAsync($"api/tasks/createtask/{selectedProjectId}", newTask);

        // Nu henter vi alle opgaver igen fra databasen
        // Det gør vi, fordi den nye opgave nu ligger i databasen, og vi vil have den med på listen med det samme
        await LoadAllTasks();

        // Derefter grupperer vi opgaverne igen efter projekter
        // Ellers ville den nye opgave bare ligge løst – den skal jo vises under det rigtige projekt
        await GroupTasks();

        // Opdaterer også listen over, hvilke brugere der er tilknyttet de forskellige opgaver
        // (selvom vi ikke har tilknyttet nogen endnu)
        await LoadTaskUsers();

        // Til sidst nulstiller vi formularen øverst på siden
        // Så bliver alle felter tomme igen, og man kan starte på en ny opgave uden at skulle slette det hele selv
        newTask = new TaskModel(); // Nulstiller formularen
    }

    // Henter hvilke brugere der er tilknyttet hver opgave
    private async Task LoadTaskUsers()
    {
        taskUsersMap.Clear();
        foreach (var task in tasks)
        {
            var usersForTask = await Http.GetFromJsonAsync<List<UserModel>>(
                $"api/userstasks/getusersfromtask/{task.TaskId}") ?? new List<UserModel>();
            taskUsersMap[task.TaskId] = usersForTask;
        }
    }

    // Sletter en opgave (med bekræftelse)
    private async Task DeleteTask(int tid)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Er du sikker på du vil slette denne task?"))
            return;
        var response = await Http.DeleteAsync($"api/tasks/delete/{tid}");
        if (response.IsSuccessStatusCode)
        {
            await LoadAllTasks();
            await GroupTasks();
            await LoadTaskUsers();
        }
    }

    // Åbner modal med en kopi af opgaven (så vi ikke ændrer originalen før gem)
    private void OpenUpdateTaskModal(TaskModel task)
    {
        SelectedTask = new TaskModel
        {
            TaskId = task.TaskId,
            Name = task.Name,
            Description = task.Description,
            StartDate = task.StartDate,
            Deadline = task.Deadline,
            CompletionDate = task.CompletionDate,
            Status = task.Status,
            ProjectId = task.ProjectId
        };
        showUpdateTaskModal = true;
    }

    private void CloseUpdateTaskModal()
    {
        SelectedTask = null;
        showUpdateTaskModal = false;
    }

    // Opdaterer opgaven via API
    private async Task UpdateTask()
    {
        if (SelectedTask == null) return;
        var response = await Http.PutAsJsonAsync($"api/tasks/update/{SelectedTask.TaskId}", SelectedTask);
        if (response.IsSuccessStatusCode)
        {
            await LoadAllTasks();
            await GroupTasks();
            await LoadTaskUsers();
            CloseUpdateTaskModal();
        }
    }

    // Tilføjer valgt bruger til valgt opgave
    private async Task AddSelectedUser()
    {
        if (selectedUserId.HasValue && selectedTaskId.HasValue)
        {
            await Http.PostAsync($"api/userstasks/addusertask/{selectedTaskId}/{selectedUserId}", null);
            selectedUserId = null;
            selectedTaskId = null;
            await LoadTaskUsers();
        }
    }

    // Henter alle brugere
    private async Task LoadUsers()
    {
        users = await Http.GetFromJsonAsync<List<UserModel>>("api/users/allusers");
    }

    // Køres én gang når siden loader første gang
    protected override async Task OnInitializedAsync()
    {
        projects = await Http.GetFromJsonAsync<List<ProjectModel>>("api/all");
        await LoadAllTasks();
        await GroupTasks();
        await LoadUsers();
        await LoadTaskUsers();
    }

    // Hjælpeklasse til at gruppere opgaver under deres projekt
    private class ProjectGroup
    {
        public ProjectModel? Project { get; set; }
        public List<TaskModel> Tasks { get; set; } = new();
    }

    // Fjerner en bruger fra en opgave og genindlæser alt
    private async Task DelUserFromTask(int taskId, int userId)
    {
        await Http.DeleteAsync($"api/userstasks/deluserfromtask/{taskId}/{userId}");
        tasks.Clear();
        groupedTasks.Clear();
        taskUsersMap.Clear();
        await OnInitializedAsync(); // Genindlæser alt fra bunden
    }
}