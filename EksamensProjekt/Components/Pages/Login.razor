@page "/login"
@using EksamensProjekt.Models
@inject Blazored.LocalStorage.ILocalStorageService LS
@inject NavigationManager Nav
@inject HttpClient Http
@rendermode InteractiveServer

<h3>Login</h3>

<input @bind="username" placeholder="Brugernavn" />
<br />
<input type="password" @bind="password" placeholder="Kode" />
<br />
<button @onclick="DoLogin">Login</button>

<p>@msg</p>

@code {
    private string username = string.Empty;
    private string password = string.Empty;
    private string msg = string.Empty;

    private async Task DoLogin()
    {
        var response = await Http.PostAsJsonAsync("api/auth/login", new UserModel
        {
            Username = username,
            Password = password
        });

        if (!response.IsSuccessStatusCode)
        {
            msg = "Forkert brugernavn eller kode";
            return;
        }

        var userData = await response.Content.ReadFromJsonAsync<UserModel>();
        if (userData == null)
        {
            msg = "Noget gik galt";
            return;
        }

        // Gem i local storage
        await LS.SetItemAsync("loggedin", userData.Username);
        await LS.SetItemAsync("userid", userData.UserId);
        await LS.SetItemAsync("isadmin", userData.IsAdmin);

        // Refresh og naviger til root
        Nav.NavigateTo(Nav.Uri, forceLoad: true);
        Nav.NavigateTo("/");
    }
}